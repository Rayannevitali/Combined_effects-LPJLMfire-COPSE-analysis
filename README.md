# Combined_effects-LPJLMfire-COPSE-analysis

This repository contains all R scripts and output data used to reproduce the analyses and figures in the manuscript:

**"Combined effects of photorespiration and fire strongly regulate atmospheric oxygen levels"**

_Rayanne Vitali_, Claire M. Belcher, Benjamin J.W. Mills, Andrew J. Watson — Science Advances (_in review_)

---

## Repository Contents

| Directory / File | Description |
|-----------------|-------------|
| `main.R`        | Main script to run the full analysis and generate figures. |
| `data/`         | Data used in the analyses. Includes datasets derived from LPJ-LMfire and COPSE simulations. |
| `Figures/`      | Figures generated by the analysis scripts. |
| `scripts/`      | Supporting R scripts for individual analyses, plotting, or data preparation. |

---
## How to Use the Code

1. Install required R libraries (see **Requirements** below).  
2. Download the extra data are required (see **Data** section).  
3. Open `main.R` and alter file paths at the top of the script as needed.  
4. Run `main.R` in R (tested on R 4.1.2).
   
---

## Requirements

- **R (≥ 4.1.2)**  
- **R Libraries:**  

```r
library(ncdf4)
library(ggplot2)
library(gtable)
library(mgcv)
library(reshape2)
library(readxl)
library(dplyr)
library(cowplot)
library(gridExtra)
library(tidyr)
library(R.matlab)
library(deeptime)
library(Cairo)
```
> Install any missing packages with install.packages("package_name") before running the analysis.

- **Git Large File Storage (LFS):**  
  Some raw model output files (`.nc`) are stored using Git LFS.  
  Make sure you have [Git LFS installed](https://git-lfs.com/) before cloning.  

---

## Data

This repository provides processed outputs from the LPJ-LMfire and COPSE models, as well as references to external datasets required for reproducibility.

### Provided in this repository

| Directory / File                  | Description                                                                                   | Notes / Regeneration                                     |
|----------------------------------|-----------------------------------------------------------------------------------------------|---------------------------------------------------------|
| `LPJLMfire_output/oxygen_fire`    | Simulations with fire dependence on O₂                                                       | Pre-processed                                           |
| `LPJLMfire_output/oxygen_productivity` | Simulations with productivity dependence on O₂                                               | Pre-processed                                           |
| `LPJLMfire_output/oxygen_fire_productivity` | Simulations with both fire and productivity dependence on O₂                             | Pre-processed                                           |
| `LPJLMfire_output/May_param_tests` | Sensitivity simulations testing different combinations of min/max parameters                 | Pre-processed                                           |
| `LPJLMfire_output/late_cret_2025` | Simulation experiments under alternative Late Cretaceous climate configurations            | Pre-processed                                           |
| `LPJLMfire_output/totals/`       | Pre-processed global total `.xlsx` files                                                    | Can be regenerated by uncommenting “Generate global total spreadsheets” in `main.R` |
| `COPSE_output/`                  | `.txt` files from COPSE model runs                                                          | Pre-processed  

### External datasets (must be downloaded separately)

- **Mills et al. (2023) proxy dataset**  
  File used: `Mills_etal_2023_AREPS_O2.xlsx`  
  Download from: [https://www.annualreviews.org/doi/abs/10.1146/annurev-earth-032320-095425](https://www.annualreviews.org/doi/abs/10.1146/annurev-earth-032320-095425)  

- **SCION geochemical data (Mills et al., 2020)**  
  File used: `geochem_data_2020.mat`  
  Download from: [https://github.com/bjwmills/SCION/tree/main/data](https://github.com/bjwmills/SCION/tree/main/data)  

- **Alaska LPJ-LMfire biomass data**  
  Source: [https://catalogue.ceda.ac.uk/uuid/af60720c1e404a9e9d2c145d2b2ead4e/](https://catalogue.ceda.ac.uk/uuid/af60720c1e404a9e9d2c145d2b2ead4e/)  
  (Raw data must first be aggregated using the provided `aggregated_alaska.R` script.)  

---

## Models

The analyses in this repository rely on two underlying models. Links to archived model versions can be found below. Please cite and refer to these repositories for full documentation and source code:

| Model       | Description                                                                                         | Zenodo DOI / GitHub |
|-------------|-----------------------------------------------------------------------------------------------------|-------------------|
| **LPJ-LMfire** | Dynamic global vegetation model used to generate fire-forcing data. Includes oxygen-sensitive fire ignition and productivity feedbacks. | Zenodo: [10.5281/zenodo.17013920](https://doi.org/10.5281/zenodo.17013920) <br> GitHub: [Rayannevitali/LPJ-LMfire-oxygen-photoresp-fire](https://github.com/Rayannevitali/LPJ-LMfire-oxygen-photoresp-fire) |
| **COPSE**   | Carbon-Oxygen-Phosphorus-Sulfur-Evolution model, updated for this manuscript to integrate fire and photorespiration feedbacks. | Zenodo: [10.5281/zenodo.17013752](https://doi.org/10.5281/zenodo.17013752) <br> GitHub: [Rayannevitali/COPSE-oxygen-photorespiration-fire](https://github.com/Rayannevitali/COPSE-oxygen-photorespiration-fire) |

> See these repositories for detailed usage instructions, documentation, and code licensing.

---
## Scripts

| Script                          | Description                                                            |
|--------------------------------|------------------------------------------------------------------------|
| `aggreggated_alaska.R`         | Aggregates regional Alaska fire simulations.                           |
| `decadal_avg.R`                 | Computes decadal averages from raw model outputs.                      |
| `global_total_function.R`       | Function to calculate global totals from gridded data.                 |
| `global_totals_spreadsheet_generator.R` | Generates spreadsheets of global totals for analysis.          |
| `globplot_function.R`           | Helper function for global plotting.                                   |
| `matrix2df_function.R`          | Converts matrix outputs into data frames for processing.               |
| `photomod_func.R`               | Functions to apply photorespiration modifiers.                         |
| `plot_helper.R`                 | Helper functions for standardized plotting routines.                   |

---

## Citation

If you use this repository, please cite both the manuscript and the archived code release:

**Manuscript**  
Vitali, R., Belcher, C. M., Mills, B. J. W., & Watson, A. J. (in review).  
*Combined effects of photorespiration and fire strongly regulate atmospheric oxygen levels.*  
Science Advances.

---
## Contact
For questions or issues, please contact the corresponding author:  **Rayanne Vitali**  rvitali@envs.au.dk
